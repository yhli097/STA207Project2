---
title: "STA207 Project2 Code"
author: "Yahui Li"
date: "2020/1/28"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r,message=FALSE}
library(tidyverse)
library(stats)
library(car)
```

1.  Explore math scaled scores in the 1st with teachers as the unit. Generate summary statistics (in forms of tables or plots) that you find informative, and explain them. 

```{r}
# https://dataverse.harvard.edu/file.xhtml?fileId=666716&version=1.0
load("~/myrepo/STA207Project2/STAR_Students.RData")
data <- data.frame(g1classtype = x$g1classtype, g1schid = x$g1schid, 
                   g1tchid = x$g1tchid, g1tmathss = x$g1tmathss)
```

Use no.omit() to remove all NA in dataset

```{r}
data <- na.omit(data)
```

Test the type of each varaible.

```{r}
sapply(data, class)
#We should change ID variables as factor.
data$g1schid <- factor(data$g1schid)
data$g1tchid <- factor(data$g1tchid)
nlevels(data$g1schid) #there are 76 school IDs
nlevels(data$g1tchid) #there are 339 teacher IDs
```

We can check each teacher ID was in only one certain type of class and in only one school ID, so we can summarize the sore by different teacher ID.

```{r}
(data_by_teacher <- data %>%
  group_by(g1classtype,g1schid,g1tchid) %>%
  summarize(mean = mean(g1tmathss), sd = sd(g1tmathss), median = median(g1tmathss),
            min = min(g1tmathss),max = max(g1tmathss)))
par(mfrow=c(2,3))
hist(data_by_teacher$mean, xlab = c("mean of math score"), 
     main =title("Histogram of mean"))
hist(data_by_teacher$sd, xlab = c("sd of math score"), 
     main =title("Histogram of standard deviation"))
hist(data_by_teacher$median, xlab = c("median of math score"), 
     main =title("Histogram of median"))
hist(data_by_teacher$min, xlab = c("min of math score"), 
     main =title("Histogram of min"))
hist(data_by_teacher$max, xlab = c("max of math score"), 
     main =title("Histogram of max"))
hist(data_by_teacher$max-data_by_teacher$min, xlab = c("range of math score"), 
     main =title("Histogram of range"))
par(mfrow=c(1,1))
```

From the histogram on the mean of math score by different teacher is normal-like. However, the histogram on standard deviation of math score by different teacher is thiner than normal distribution.



2.  Write down a two-way ANOVA model to study the effects of class types on math scaled scores in 1st grade, with the school indicator as the other factor. Explain your notation.

$$Y_{ijk} = \mu_{ij} + \epsilon_{ijk} \text{ with } \epsilon_{ijk} \overset{\mathrm{i.i.d.}}{\sim} \mathcal{N}(0, \sigma^2),$$

where 
$\mu_{ij} = \mu + \alpha_i + \beta_j + \gamma_{ij}$.

By notation, 

$i$ represents the treatment of class type, and  $i = 1, 2, 3$ means the type of class is `small`, `regular` and `regular with aide`.

$j$ represents the treatment of school ID, and $j = 1, \cdots, 76$. 

$k$ represents different cases by teacher ID, and $k = 1, \cdots, 339$.

$Y_{ijk}$ refers to summary information about math score for $k$-th teacher ID in  $i$-th type of class and $j$-th school ID.

$\mu$ is the grand mean, $\alpha_i$ is the additive main effect of level $i$ from the first factor, $\beta_j$ is the additive main effect of level $j$ from the second factor and $\gamma_{ij}$ is the non-additive interaction effect of treatment $(i,j)$ from both factors.

To ensure identifiability of parameters, we can add the following "sum-to-zero" constraints:

$$\sum_i \alpha_i = \sum_j \beta_j = \sum_i \gamma_{ij} =\sum_j \gamma_{ij}= 0$$

Assumptions:

a. the data points are relevant with respect to the scientific question under investigation;
b. the mean of the response variable is influenced additively (if not interaction term) and linearly by the factors;
c. the errors are independent;
d. the errors have the same variance;
e. the errors are normally distributed.

3.  Explain why your model is appropriate for this task on this data set. You may want to include statistics and plots in your explanation. 

```{r}
pairs(data_by_teacher[c(4,1,2)])
```

From the pairwise plot there is no non-linearity pattern. 

```{r,warning= FALSE}
interaction.plot(data_by_teacher$g1classtype, data_by_teacher$g1schid, 
                 data_by_teacher$mean,legend = FALSE)
```

4.  Fit the model you choose in Task 2 and show your fits in the report. 


```{r}
full_model=lm(mean~g1classtype+g1schid+g1classtype*g1schid,data=data_by_teacher);

reduced_model=lm(mean~g1classtype+g1schid,data=data_by_teacher);

anova(reduced_model,full_model)
```

The test result show that interaction effects are very likely to be absent from this data set. This means that we need to treat each combination as a unit, whereas we can compare each type of main effects separately.


5.  Conduct model diagnostic and/or sensitivity analysis. 

a. independence, need descriptive 

In this experiment, researchers assigned students to small classes, regular classed and regular classes with aide randomly.

From the Residuals vs Fitted Values scatterpoint, we can see that the residuals are around zero. It shows that the zero mean assumption.

Besides, these points are uniformly distributed on both sides of x-axis, which means that our model does not violate the equal variance assumption.

```{r,warning=FALSE}
anova.fit<-aov(mean~g1classtype+g1schid,data=data_by_teacher)
#check the mean zero and equal variance
plot(anova.fit, which = 1)
summary(anova.fit)
```

The Normal Q-Q plot illustrates that the residuals are a little bit heavy tailed compared with the normal distribution. In order to check the normality assumption more precisely, we conduct the Shapiro-Wilk Normality Test. The result shows that $W=0.9802$ and the $p-value$ is 0.0001, which is much smaller than the significant level 0.01. Therefore, we are 99% confident that the residuals are normally distributed and our model follows the normality assumption.

```{r}
#normality assumption
plot(anova.fit, which = 2)

shapiro.test(anova.fit$residuals)
```

```{r}
# Krusal-Wallis test:
kruskal.test(mean ~ interaction(g1classtype, g1schid) , data = data_by_teacher)
```

```{r}
# Krusal-Wallis test:

kruskal.test(mean ~ interaction(g1classtype, g1schid) , data = data_by_teacher)
```


6.  Test whether there is a difference in math scaled score in 1st grade across teachers in different class types. Justify your choice of test. 

We can use the Tukey-Kramer method for this task.

```{r}
alpha=0.05;
T.ci=TukeyHSD(anova.fit,conf.level = 1-alpha)
plot(T.ci, las=1 , col="brown")
```

7.  Discuss whether you are able to make any causal statements based on your analysis. 

8.  Is there any difference between the results from Project 2 compared to the results from Project 1?
